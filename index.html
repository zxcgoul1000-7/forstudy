<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Игра Мемори</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="vendor/react.development.js"></script>
  <script src="vendor/react-dom.development.js"></script>
  <script src="vendor/babel.min.js"></script>
  <!-- <script src="dubaua/get-declension"></script> -->
  <!--подключите библиотеки React, ReactDOM и BabelJS-->
  <script src="data.js"></script>
  <!--подключите файл данных-->
</head>
<body>
  <div id="root">Корневой элемент</div>
  
  <script type="text/babel">
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container)
    root.render(<App images={images}/>);


    const useGame = (images) => {
      const [finishedItems, setFinishedItems] = React.useState([]);
      const [stepsCount, setStepsCount] = React.useState(0);

      const checkItems = (firstItem, secondItem) => {
        const fisrtImage = images.find(({id}) => id === firstItem);
        const secondImage = images.find(({id}) => id === secondItem);
        if (fisrtImage.url === secondImage.url) {
          setFinishedItems((items) => [...items, firstItem, secondItem])
        }
        setStepsCount((i) => i + 1);
      };
      
      const handleReset = () => {
        setFinishedItems([]);
        setStepsCount(0);
      }

      
      const isGameOver = finishedItems.length === images.length;
      return {
        finishedItems,
        handleReset,
        checkItems,
        isGameOver,
        stepsCount
      };
    };

    function App ({images = []}) {
      const {
        finishedItems,
        handleReset,
        checkItems,
        errorsCount,
        isGameOver,
        stepsCount,
      } = useGame(images);

      return (
        <section className = 'game container'>
          <Progress value={finishedItems.length} max={images.length} />
            <p class="progress-description">Открыто <span>{finishedItems.length/2}</span> / <span>6</span></p>
            <div className='steps'> {stepsCount} шагов </div>
          <Grid images = {images} finishedItems = {finishedItems} checkItems = {checkItems}/> 
          { isGameOver && (<Modal>
            <h3 className="modal-caption">Победа!</h3>
            <p className="modal-description">Вы собрали все пары за {stepsCount} шагов</p>
            <button onClick={handleReset} className="button" type="button">Новая игра</button>
          </Modal> 
          )}
        </section>
      );
    }


    function Progress ({value, max}) {
      return (
        <div className ="progress-wrapper">
          <div className="progress" style={{width: `${value / max * 100}%`}}></div>
        </div>
      );
    }

    function Modal ({children, className}) {
      return (
        <div className="modal">
          <div className={`modal-box ${className}`}>
            {children}
          </div>
        </div>
      )
    }

    function Grid ({images, finishedItems, checkItems}) {
      const [visibledItems, setVisibledItems] = React.useState([]);

      const handleCardClick = (id) => {
        if (visibledItems.includes(id)) {
          return;
        }
        switch (visibledItems.length) {
          case 0:
            setVisibledItems([id]);
            break;
          case 1:
            setVisibledItems((items) => [...items, id]);
            checkItems(visibledItems[0], id);
            setTimeout (() => {
              setVisibledItems ([]);
            }, 800)
            break;
          default:
            setVisibledItems ([]);
        }
      }

      const cards = images.map((item)=> (
        <Card
        key = {item.id}
        item = {item}
        isVisibled = {visibledItems.includes(item.id)}
        isFinished = {finishedItems.includes(item.id)}
        onCardClick={handleCardClick}
        />
    ));
    return (
        <ul className="cards">
          {cards}
        </ul>  
    )
    }

    function Card ({item, isFinished, isVisibled, onCardClick}) {
      const {url, id} = item;
      const className = `card ${
      isVisibled ? 'card-show' : ''
      } ${
      isFinished ? 'card-finished' : ''
      }`;

      const handleClick = () => {
        if (isFinished) {
          return;
        }
        onCardClick(id);
      }

      return(
        <li onClick = {handleClick} className = {className}>
          <img src={url} width="204" height="144" alt="Котик"/>
        </li>  
      );
    }


  </script>
</body>
</html>
