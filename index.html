<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Игра Мемори</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="vendor/react.development.js"></script>
    <script src="vendor/react-dom.development.js"></script>
    <script src="vendor/babel.min.js"></script>
    <script src="vendor/get-declension.min.umd.js"></script>
    <!--подключите библиотеки React, ReactDOM и BabelJS-->
    <script src="data.js"></script>
    <script src="settings.js"></script>
    <!--подключите файл данных-->
  </head>
  <body>
    <div id="root">Корневой элемент</div>

    <script type="text/babel">
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App getImages={getImages} results={results} />);

      function App({ getImages, results = [] }) {
        const [page, setPage] = React.useState(AppRoute.Initial);
        const [result, setResult] = React.useState(0);
        const [images, setImages] = React.useState([]);
        const [gameType, setGameType] = React.useState([]);
        const showResults = (imagesCount) => {
          setResult(imagesCount);
          setPage(AppRoute.Results);
        };
        const handleReset = () => {
          setPage(AppRoute.Initial);
        };
        const handleStart = (type) => {
          setImages(getImages(type));
          setGameType(type);
          setPage(AppRoute.Game);
        };
        const getPage = (route) => {
          switch (route) {
            case AppRoute.Initial:
              return <InitialPage onStart={handleStart} />;
            case AppRoute.Game:
              return <GamePage images={images} gameType={gameType} onShowResults={showResults} />;
            case AppRoute.Results:
              return (
                <ResultsPage
                  current={result}
                  onResetGame={handleReset}
                  results={results}
                />
              );
            default:
              return null;
          }
        };
        return getPage(page);
      }

      function InitialPage({ onStart }) {
        const handleStart = (type) => {
          onStart(type);
        };

        return (
          <section className="rules container">
            <h2>Добро пожаловать!</h2>
            <p>Memory — игра для тренировки визуальной памяти</p>
            <div className="rules-panel">
              <h3>Правила игры</h3>
              <ul className="rules-list">
                <li>
                  В наборе есть множество карточек – по две штуки с одним и тем
                  же рисунком.
                </li>
                <li>
                  Нужно разложить карточки «рубашкой» вверх на столе, а затем
                  переворачивать по две.
                </li>
                <li>
                  Если они совпадают – игрок забирает их и получает ещё один
                  ход.
                </li>
              </ul>
            </div>
            {GAME_TYPES.map(({ label, type }) => (
              <button
                onClick={() => handleStart(type)}
                className={`ico-button ico-button-${type}`}
                key={type}
                type="button"
              >
                {label}
              </button>
            ))}
            ;
          </section>
        );
      }

      function ResultsPage({ results, current, onResetGame }) {
        const sortedResults = [
          ...results,
          { name: "Ваш результат", stepsCount: current },
        ].sort((a, b) => a.stepsCount - b.stepsCount);
        const resultsRow = sortedResults.map(({ name, stepsCount }, index) => (
          <tr
            key={name}
            className={`result-table-row ${
              stepsCount === current ? "active" : ""
            }`}
          >
            <td> {index + 1}</td>
            <td> {name}</td>
            <td> {stepsCount}</td>
          </tr>
        ));
        return (
          <section className="result container">
            <h2>Лучшие результаты:</h2>
            <p>
              Вы завершили игру за <b>{current} шагов</b>, так держать!
            </p>
            <table className="result-table">
              <thead>
                <tr className="result-table-row">
                  <th>Место</th>
                  <th>Имя</th>
                  <th>Шаги</th>
                </tr>
              </thead>
              <tbody>{resultsRow}</tbody>
            </table>
            <p>Новая игра</p>
            <button onClick={onResetGame} className="button" type="button">
              Новая игра
            </button>
          </section>
        );
      }

      const useGame = (images) => {
        const [finishedItems, setFinishedItems] = React.useState([]);
        const [stepsCount, setStepsCount] = React.useState(0);

        const checkItems = (firstItem, secondItem) => {
          const fisrtImage = images.find(({ id }) => id === firstItem);
          const secondImage = images.find(({ id }) => id === secondItem);
          if (fisrtImage.url === secondImage.url) {
            setFinishedItems((items) => [...items, firstItem, secondItem]);
          }
          setStepsCount((i) => i + 1);
        };

        const handleReset = () => {
          setFinishedItems([]);
          setStepsCount(0);
        };

        const isGameOver = finishedItems.length === images.length;
        return {
          finishedItems,
          handleReset,
          checkItems,
          isGameOver,
          stepsCount,
        };
      };

      function GamePage({ images = [], onShowResults, gameType }) {
        const {
          finishedItems,
          handleReset,
          checkItems,
          errorsCount,
          isGameOver,
          stepsCount,
        } = useGame(images);

        const handleResultsClick = () => {
          onShowResults(finishedItems.length / 2);
        };

        return (
          <section className="game container">
            <GameHeader value={finishedItems.length} max={images.length} />
            <p className="progress-description">
              Открыто <span>{finishedItems.length / 2}</span> / <span>6</span>
            </p>
            <div className="steps"> {stepsCount} шагов </div>
            <Grid
              gameType={gameType}
              images={images}
              finishedItems={finishedItems}
              checkItems={checkItems}
            />
            {isGameOver && (
              <Modal>
                <h3 className="modal-caption">Победа!</h3>
                <p className="modal-description">
                  Теперь давайте узнаем результаты этой партии
                </p>
                <button
                  onClick={handleResultsClick}
                  className="button"
                  type="button"
                >
                  Показать результаты
                </button>
              </Modal>
            )}
          </section>
        );
      }

      function GameHeader({ value, max }) {
        return (
          <div className="progress-wrapper">
            <div
              className="progress"
              style={{ width: `${(value / max) * 100}%` }}
            ></div>
          </div>
        );
      }

      function Modal({ children, className }) {
        return (
          <div className="modal">
            <div className={`modal-box ${className}`}>{children}</div>
          </div>
        );
      }

      function Grid({ images, finishedItems, checkItems, gameType }) {
        const [visibledItems, setVisibledItems] = React.useState([]);

        const handleCardClick = (id) => {
          if (visibledItems.includes(id)) {
            return;
          }
          switch (visibledItems.length) {
            case 0:
              setVisibledItems([id]);
              break;
            case 1:
              setVisibledItems((items) => [...items, id]);
              checkItems(visibledItems[0], id);
              setTimeout(() => {
                setVisibledItems([]);
              }, TIMEOUT);
              break;
            default:
              setVisibledItems([]);
          }
        };

        const cards = images.map((item) => (
          <Card
            key={item.id}
            item={item}
            isVisibled={visibledItems.includes(item.id)}
            isFinished={finishedItems.includes(item.id)}
            onCardClick={handleCardClick}
          />
        ));
        return <ul className={`cards cards-theme-${gameType}`}>{cards}</ul>;
      }

      function Card({ item, isFinished, isVisibled, onCardClick }) {
        const { url, id } = item;
        const className = `card ${isVisibled ? "card-show" : ""} ${
          isFinished ? "card-finished" : ""
        }`;

        const handleClick = () => {
          if (isFinished) {
            return;
          }
          onCardClick(id);
        };

        return (
          <li onClick={handleClick} className={className}>
            <img src={url} width="204" height="144" alt="Котик" />
          </li>
        );
      }
    </script>
  </body>
</html>
